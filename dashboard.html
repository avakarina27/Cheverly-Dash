<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cheverly Air Quality Dashboard</title>
  <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/7/7c/Air_quality_icon.png" />

  <!-- Libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <link rel="stylesheet" href="style.css" />

  <style>
    #layout-row { display: flex; flex-wrap: wrap; }
    #sidebar { flex: 1 1 320px; padding: 1rem; background: #f4f6f8; }
    #map-and-chart { flex: 2 1 600px; padding: 1rem; }
    #map { width: 100%; height: 460px; border: 1px solid #ccc; border-radius: 8px; }
    #chart { width: 100%; height: 280px; margin-top: 1rem; }
    .legend-grid { display: grid; gap: .5rem; margin-top: .5rem; }
    .legend-box { display: flex; align-items: center; gap: .5rem; font-size: .9rem; }
    .dot { width: 16px; height: 16px; border-radius: 50%; display: inline-block; border: 1px solid #aaa; }
    .dot--good { background: green; }
    .dot--moderate { background: yellow; }
    .dot--unhealthy { background: orange; }
    .dot--veryunhealthy { background: red; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">Cheverly Air Quality Dashboard</div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="dashboard.html" aria-current="page">Dashboard</a>
      <a href="writeup.html">Community Insights</a>
    </nav>
  </header>

  <div id="layout-row">
    <aside id="sidebar">
      <label>Device:</label>
      <select id="deviceSelect"></select>
      <button id="refresh">Refresh Data</button>

      <h4>Device Info</h4>
      <pre id="deviceInfo">Select a device…</pre>

      <h4>PM2.5 Legend (µg/m³)</h4>
      <div class="legend-grid">
        <div class="legend-box"><span class="dot dot--good"></span><strong>Good</strong> 0–12</div>
        <div class="legend-box"><span class="dot dot--moderate"></span><strong>Moderate</strong> 12–35</div>
        <div class="legend-box"><span class="dot dot--unhealthy"></span><strong>Unhealthy</strong> 35–55</div>
        <div class="legend-box"><span class="dot dot--veryunhealthy"></span><strong>Very Unhealthy</strong> 55+</div>
      </div>
    </aside>

    <main id="map-and-chart">
      <div id="map"></div>
      <canvas id="chart"></canvas>
    </main>
  </div>

  <script>
    const PURPLEAIR_API_KEY = "9ADB5C6C-A9B0-11EF-A261-42010A80000F";
    const CHEVERLY_CENTER = [38.93, -76.91];
    const CHEVERLY_POLY = turf.polygon([[[-76.9167,38.9352],[-76.9424,38.9178],[-76.9094,38.8929],[-76.8688,38.9266],[-76.9167,38.9352]]]);
    const DEMO_QUANTAQ = [{sn:"QA123",source:"QuantAQ",lat:38.93,lon:-76.91,pm25:22,last_seen:new Date()},{sn:"QA456",source:"QuantAQ",lat:38.925,lon:-76.905,pm25:14,last_seen:new Date()}];

    let devices = [];
    let markersBySN = new Map();
    const map = L.map("map").setView(CHEVERLY_CENTER, 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    const layerGroup = L.layerGroup().addTo(map);
    const sel = document.getElementById("deviceSelect");
    const infoBox = document.getElementById("deviceInfo");
    const refreshBtn = document.getElementById("refresh");

    const chart = new Chart(document.getElementById("chart"), {
      type: "line",
      data: { datasets: [{label:"PM2.5 (µg/m³)",data:[],borderColor:"#0074D9",fill:false}] },
      options: { parsing:true, scales:{x:{type:"time",time:{unit:"hour"}},y:{title:{display:true,text:"µg/m³"}}} }
    });

    function pmToColor(v){return v<=12?"green":v<=35?"yellow":v<=55?"orange":"red";}
    function fmt(d){return new Date(d).toLocaleString();}
    function demoSeries(){return Array.from({length:24},(_,i)=>({x:new Date(Date.now()-i*3600e3),y:10+Math.random()*30}));}

    async function fetchPurpleAir(){
      const url="https://api.purpleair.com/v1/sensors?nwlng=-76.955&nwlat=38.955&selng=-76.860&selat=38.900&fields=sensor_index,name,latitude,longitude,pm2.5_atm,last_seen,location_type";
      const res=await fetch(url,{headers:{"X-API-Key":PURPLEAIR_API_KEY}});
      const json=await res.json();
      const f=json.fields; const idx=n=>f.indexOf(n);
      return (json.data||[]).map(r=>({
        sn:String(r[idx("sensor_index")]),
        name:r[idx("name")],
        source:"PurpleAir",
        lat:Number(r[idx("latitude")]),
        lon:Number(r[idx("longitude")]),
        pm25:Number(r[idx("pm2.5_atm")]),
        last_seen:new Date(Number(r[idx("last_seen")])*1000)
      })).filter(d=>turf.booleanPointInPolygon(turf.point([d.lon,d.lat]),CHEVERLY_POLY));
    }

    async function fetchHist(sn){
      const url=`https://api.purpleair.com/v1/sensors/${sn}/history?fields=pm2.5_atm,time_stamp&average=30&n=48`;
      const r=await fetch(url,{headers:{"X-API-Key":PURPLEAIR_API_KEY}});
      const j=await r.json(); const f=j.fields; const iT=f.indexOf("time_stamp"); const iP=f.indexOf("pm2.5_atm");
      return (j.data||[]).map(x=>({x:new Date(x[iT]*1000),y:x[iP]}));
    }

    function populate(){
      sel.innerHTML=""; devices.forEach(d=>{const o=document.createElement("option");o.value=d.sn;o.textContent=`${d.sn} (${d.source})`;sel.append(o);});
    }

    function updateMap(){
      layerGroup.clearLayers(); markersBySN=new Map();
      devices.forEach(d=>{
        const m=L.circleMarker([d.lat,d.lon],{radius:9,color:pmToColor(d.pm25),fillColor:pmToColor(d.pm25),fillOpacity:0.8}).addTo(layerGroup)
          .bindPopup(`<b>${d.sn}</b><br>PM2.5: ${d.pm25.toFixed(1)} µg/m³`);
        m.on("click",()=>{sel.value=d.sn;showInfo(d.sn);updateChart(d.sn);});
        markersBySN.set(d.sn,m);
      });
    }

    function showInfo(sn){
      const d=devices.find(x=>x.sn===sn);
      infoBox.textContent=`Source: ${d.source}\nSN: ${d.sn}\nPM2.5: ${d.pm25} µg/m³\nLast Seen: ${fmt(d.last_seen)}`;
      const m=markersBySN.get(sn); if(m){m.openPopup();map.panTo([d.lat,d.lon]);}
    }

    async function updateChart(sn){
      const d=devices.find(x=>x.sn===sn);
      if(d.source==="PurpleAir"){try{const h=await fetchHist(d.sn);if(h.length){chart.data.datasets[0].data=h;chart.update();return;}}catch(e){}}
      chart.data.datasets[0].data=demoSeries(); chart.update();
    }

    async function init(){
      devices=[...DEMO_QUANTAQ];
      try{const pa=await fetchPurpleAir();devices.push(...pa);}catch(e){console.warn(e);}
      populate(); updateMap();
      if(devices.length){sel.value=devices[0].sn;showInfo(sel.value);updateChart(sel.value);}
    }

    refreshBtn.onclick=()=>{showInfo(sel.value);updateChart(sel.value);}
    sel.onchange=()=>{showInfo(sel.value);updateChart(sel.value);}
    init();
  </script>
</body>
</html>
