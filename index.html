<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cheverly Air Quality Dashboard</title>

  <!-- Favicon (the little icon in browser tabs) -->
  <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/7/7c/Air_quality_icon.png" />

  <!-- SEO + Share preview -->
  <meta name="description" content="Live air quality monitoring dashboard for Cheverly, Maryland, displaying PM2.5 and sensor data from QuantAQ and PurpleAir." />
  <meta property="og:title" content="Cheverly Air Quality Dashboard" />
  <meta property="og:description" content="Live air quality monitoring dashboard for Cheverly, Maryland." />
  <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/6/6e/Air_pollution_skyline.jpg" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://avakarina27.github.io/Cheverly-Dash/" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- CSS + Map/Chart libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    :root {
      --bg-header: #2c3e50;
      --bg-panel: #ecf0f1;
      --border-color: #ccc;
      --radius: 4px;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      margin: 0;
      color: #2c3e50;
    }
    header {
      background: var(--bg-header);
      color: white;
      padding: 1em 1.5em;
    }
    header h2 {
      margin: 0;
      font-weight: 600;
    }
  </style>
</head>

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      Roboto, "Helvetica Neue", sans-serif;
    margin: 0;
    background: #fff;
    color: var(--text-dark);
  }

  header {
    background: var(--bg-header);
    color: white;
    padding: 0.8em 1.5em;
  }

  header h2 {
    margin: 0;
    font-weight: 600;
    font-size: 1.4rem;
  }

  #layout-row {
    display: flex;
    flex-wrap: wrap;
  }

  #sidebar {
    background: var(--bg-panel);
    flex: 1 1 320px;
    min-width: 280px;
    max-width: 400px;
    padding: 1rem;
    box-sizing: border-box;
    border-right: 1px solid var(--border-color);
  }

  #map-and-chart {
    flex: 2 1 600px;
    min-width: 300px;
    box-sizing: border-box;
    padding: 1rem;
  }

  #map {
    width: 100%;
    height: 420px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    margin-bottom: 1rem;
  }

  #chart {
    width: 100%;
    max-height: 280px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: 0.5rem;
    box-sizing: border-box;
    background: #fff;
  }

  label {
    font-size: 0.9rem;
    font-weight: 600;
    display: block;
    margin-bottom: 0.25rem;
  }

  select,
  button {
    width: 100%;
    box-sizing: border-box;
    padding: 0.5em 0.6em;
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
    font-size: 0.9rem;
    background: #fff;
    margin-bottom: 0.75rem;
  }

  button {
    background: #ffffff;
    cursor: pointer;
  }
  button:hover {
    background: #f8f8f8;
  }

  h4 {
    margin: 1rem 0 0.5rem;
    font-size: 1rem;
  }

  pre {
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    background: #fff;
    color: #222;
    padding: 0.6rem;
    font-size: 0.8rem;
    line-height: 1.3;
    white-space: pre-wrap;
    min-height: 4em;
  }

  /* make Leaflet zoom buttons rounded */
  .leaflet-control-zoom a {
    border-radius: var(--radius) !important;
  }
</style>
</head>

<body>
<header>
  <h2>Cheverly Air Quality Monitoring Dashboard</h2>
</header>

<div id="layout-row">
  <div id="sidebar">
    <label for="deviceSelect">Device:</label>
    <select id="deviceSelect"></select>

    <button id="refresh">Refresh Data</button>

    <h4>Device Info</h4>
    <pre id="deviceInfo">Select a device…</pre>

    <h4>PM2.5 Legend (µg/m³)</h4>
    <pre>
Good           0–12
Moderate      12–35
Unhealthy     35–55
Very Unhealthy >55
    </pre>
  </div>

  <div id="map-and-chart">
    <div id="map"></div>
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
/* ================== CONFIG ================== */

// 1. Put your PurpleAir READ API key here:
const PURPLEAIR_API_KEY = "9ADB5C6C-A9B0-11EF-A261-42010A80000F";

// Cheverly map center [lat, lon]
const CHEVERLY_CENTER = [38.93, -76.91];

// Bounding box around Cheverly for PurpleAir fetch
const BBOX = {
  nwlat: 38.955,
  nwlng: -76.955,
  selat: 38.900,
  selng: -76.860
};

// Cheverly polygon (lon, lat order) for more precise filtering
const CHEVERLY_POLY = turf.polygon([[
  [-76.91678436636381, 38.93522186903985],
  [-76.9424153226023,  38.917845309789726],
  [-76.90942709291147, 38.89295210551228],
  [-76.86884580022874, 38.92663271296058],
  [-76.91678436636381, 38.93522186903985]
]]);

// Demo QuantAQ devices so UI isn't empty if PurpleAir call fails
const DEMO_QUANTAQ = [
  {
    sn: "QA123",
    source: "QuantAQ",
    lat: 38.93,
    lon: -76.91,
    pm25: 22,
    city: "Cheverly",
    last_seen: new Date(),
    // no sensor_index for QuantAQ demo
  },
  {
    sn: "QA456",
    source: "QuantAQ",
    lat: 38.925,
    lon: -76.905,
    pm25: 14,
    city: "Cheverly",
    last_seen: new Date()
  }
];

/* ================== DOM REFS ================== */
const sel        = document.getElementById("deviceSelect");
const info       = document.getElementById("deviceInfo");
const refreshBtn = document.getElementById("refresh");
const ctx        = document.getElementById("chart");

/* ================== MAP SETUP ================== */
const map = L.map("map").setView(CHEVERLY_CENTER, 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

const layerGroup = L.layerGroup().addTo(map);

/* ================== STATE ================== */
let devices = [];              // merged list of QuantAQ + PurpleAir
let markersBySN = new Map();   // map from sn -> Leaflet marker
let chart;                     // Chart.js instance

/* ================== HELPERS ================== */
function pmToColor(v){
  if (v == null || isNaN(v)) return "gray";
  if (v <= 12) return "green";
  if (v <= 35) return "yellow";
  if (v <= 55) return "orange";
  return "red";
}

function fmtDate(d){
  try {
    return new Date(d).toLocaleString();
  } catch {
    return String(d);
  }
}

// Fallback random-ish timeseries for QuantAQ demo devices
function demoTimeseries() {
  return Array.from({length: 30}, (_, i) => ({
    t: new Date(Date.now() - i * 3600e3), // 1 hr apart
    v: Math.random() * 30 + 10
  }));
}

/* ================== PURPLEAIR LIVE FETCHES ================== */

// Get current PurpleAir sensors in/near Cheverly
async function fetchPurpleAirCheverly(){
  if (!PURPLEAIR_API_KEY) {
    console.warn("No PurpleAir API key set, returning []");
    return [];
  }

  const fieldsWanted = [
    "sensor_index",
    "name",
    "latitude",
    "longitude",
    "last_seen",
    "pm2.5_atm",
    "pm2.5_atm_a",
    "pm2.5_atm_b",
    "pm2.5",
    "confidence",
    "location_type"
  ];

  const url =
    "https://api.purpleair.com/v1/sensors" +
    `?fields=${encodeURIComponent(fieldsWanted.join(","))}` +
    `&nwlng=${BBOX.nwlng}&nwlat=${BBOX.nwlat}` +
    `&selng=${BBOX.selng}&selat=${BBOX.selat}` +
    `&location_type=0`; // outdoor only

  const res = await fetch(url, {
    headers: {
      "X-API-Key": PURPLEAIR_API_KEY
    }
  });

  if (!res.ok) {
    throw new Error(`PurpleAir HTTP ${res.status}`);
  }

  const json = await res.json();
  const fields = json.fields || [];
  const idx = name => fields.indexOf(name);

  const iLat  = idx("latitude");
  const iLon  = idx("longitude");
  const iSN   = idx("sensor_index");
  const iName = idx("name");
  const iSeen = idx("last_seen");

  // prefer pm2.5_atm -> pm2.5 -> etc.
  let iPM = idx("pm2.5_atm");
  if (iPM < 0) iPM = idx("pm2.5");
  if (iPM < 0) iPM = idx("pm2.5_atm_a");
  if (iPM < 0) iPM = idx("pm2.5_atm_b");

  // Build objects from PurpleAir rows
  let rows = (json.data || []).map(row => {
    const lat  = Number(row[iLat]);
    const lon  = Number(row[iLon]);
    const sn   = String(row[iSN]); // this is sensor_index
    const name = row[iName];
    const pm25 = iPM >= 0 ? Number(row[iPM]) : null;

    // PurpleAir last_seen is epoch seconds
    const seenUnix = row[iSeen];
    const lastSeen = seenUnix ? new Date(Number(seenUnix) * 1000) : null;

    return {
      sn: sn, // we'll use sensor_index as sn
      source: "PurpleAir",
      name: name,
      lat: lat,
      lon: lon,
      pm25: pm25,
      last_seen: lastSeen,
      city: "Cheverly",
      sensor_index: sn // keep sensor_index around for /history calls
    };
  });

  // Filter out nonsensical coords
  rows = rows.filter(d => isFinite(d.lat) && isFinite(d.lon));

  // Filter to only points inside your Cheverly polygon
  rows = rows.filter(d => {
    const pt = turf.point([d.lon, d.lat]); // [lon, lat]
    return turf.booleanPointInPolygon(pt, CHEVERLY_POLY);
  });

  return rows;
}

// Fetch time-series history for a single PurpleAir sensor
// We'll request ~24 hours of 30-min averaged PM2.5.
async function fetchPurpleAirHistory(sensorIndex) {
  if (!PURPLEAIR_API_KEY) {
    console.warn("No PurpleAir API key set. No history.");
    return [];
  }

  const histFields = [
    "time_stamp",
    "pm2.5_atm",
    "pm2.5",
    "pm2.5_atm_a",
    "pm2.5_atm_b"
  ];

  const url =
    `https://api.purpleair.com/v1/sensors/${sensorIndex}/history` +
    `?fields=${encodeURIComponent(histFields.join(","))}` +
    `&average=30&n=48`;

  console.log("[fetchPurpleAirHistory] URL:", url);

  const res = await fetch(url, {
    headers: { "X-API-Key": PURPLEAIR_API_KEY }
  });

  console.log("[fetchPurpleAirHistory] HTTP status:", res.status);

  if (!res.ok) {
    // we throw so updateChartForDevice can catch and fallback
    throw new Error(`History HTTP ${res.status}`);
  }

  const json = await res.json();
  console.log("[fetchPurpleAirHistory] raw response:", json);

  const f = json.fields || [];
  const idx = name => f.indexOf(name);

  let iPM = idx("pm2.5_atm");
  if (iPM < 0) iPM = idx("pm2.5");
  if (iPM < 0) iPM = idx("pm2.5_atm_a");
  if (iPM < 0) iPM = idx("pm2.5_atm_b");

  const iTS = idx("time_stamp");

  if (iTS < 0 || iPM < 0) {
    console.warn("[fetchPurpleAirHistory] missing required fields in response");
    return [];
  }

  const series = (json.data || []).map(row => {
    const tsUnix = row[iTS]; // epoch seconds
    const pmVal = row[iPM];
    return {
      t: new Date(Number(tsUnix) * 1000),
      v: pmVal !== null && pmVal !== undefined ? Number(pmVal) : null
    };
  }).filter(p => p.v != null && !Number.isNaN(p.v));

  console.log("[fetchPurpleAirHistory] parsed series:", series);

  return series;
}

/* ================== RENDERING ================== */
function populateSelect(){
  sel.innerHTML = "";
  devices.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d.sn;
    opt.textContent = `${d.sn} (${d.source})`;
    sel.appendChild(opt);
  });
}

function updateMap(){
  layerGroup.clearLayers();
  markersBySN.clear();

  devices.forEach(d => {
    const markerColor = pmToColor(d.pm25);

    const marker = L.circleMarker([d.lat, d.lon], {
      radius: d.source === "PurpleAir" ? 9 : 10,
      color: markerColor,
      fillColor: markerColor,
      fillOpacity: 0.8,
      weight: 1
    })
    .addTo(layerGroup)
    .bindPopup(
      `<b>${d.sn}</b> — ${d.source}<br>` +
      (d.pm25 != null ? `PM2.5: ${d.pm25.toFixed(1)} µg/m³<br>` : "") +
      (d.last_seen ? `Last seen: ${fmtDate(d.last_seen)}` : "")
    );

    markersBySN.set(d.sn, marker);
  });
}

function showInfo(sn){
  const d = devices.find(x => x.sn === sn);
  if (!d) {
    info.textContent = "Select a device…";
    return;
  }

  info.textContent =
`Source: ${d.source}
SN: ${d.sn}
PM2.5: ${d.pm25 != null ? d.pm25.toFixed(1) + " µg/m³" : "N/A"}
Last Seen: ${d.last_seen ? fmtDate(d.last_seen) : "N/A"}
Lat/Lon: ${d.lat.toFixed(5)}, ${d.lon.toFixed(5)}`;

  const m = markersBySN.get(sn);
  if (m) {
    m.openPopup();
    map.panTo([d.lat, d.lon]);
  }
}

/* ---------- CHART SETUP ---------- */
chart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      {
        label: "PM2.5 (µg/m³)",
        data: [],
        borderColor: "#2980b9",
        fill: false
      }
    ]
  },
  options: {
    parsing: false,
    scales: {
      x: {
        type: "time",
        time: { unit: "hour" },
        ticks: { maxTicksLimit: 6 }
      },
      y: {
        title: { display: true, text: "µg/m³" }
      }
    }
  }
});

// Update chart to show live PurpleAir history IF available,
// otherwise fall back to demo data.
async function updateChartForDevice(sn) {
  const d = devices.find(x => x.sn === sn);
  console.log("[updateChartForDevice] selected device:", d);

  if (!d) {
    console.warn("No device found for", sn);
    return;
  }

  // Case 1: PurpleAir device with sensor_index -> try real history
  if (d.source === "PurpleAir" && d.sensor_index) {
    try {
      console.log("[updateChartForDevice] fetching history for PurpleAir", d.sensor_index);
      const hist = await fetchPurpleAirHistory(d.sensor_index);
      console.log("[updateChartForDevice] history points:", hist.length, hist);

      if (hist.length > 0) {
        chart.data.labels = hist.map(p => p.t);
        chart.data.datasets[0].data = hist.map(p => p.v);
        chart.data.datasets[0].label = `PM2.5 (µg/m³) - ${d.sn}`;
        chart.update();
        return;
      } else {
        console.warn("No history data returned for this sensor. Falling back to demo.");
      }
    } catch (err) {
      console.warn("History fetch failed:", err);
      // we'll fall through to demo
    }
  } else {
    console.log("[updateChartForDevice] not PurpleAir or no sensor_index, using demo series");
  }

  // Case 2: fallback demo data
  const data = demoTimeseries();
  console.log("[updateChartForDevice] demoTimeseries()", data);

  chart.data.labels = data.map(p => p.t);
  chart.data.datasets[0].data = data.map(p => p.v);
  chart.data.datasets[0].label = d.source === "PurpleAir"
    ? `PM2.5 (µg/m³) - ${d.sn} (no history)`
    : `PM2.5 (µg/m³) - demo`;

  chart.update();
}


/* ================== INIT ================== */
async function init(){
  // start with QuantAQ demo devices
  devices = [...DEMO_QUANTAQ];

  // try to fetch PurpleAir live sensors, merge in
  try {
    const pa = await fetchPurpleAirCheverly();
    const existing = new Set(devices.map(d => d.sn));
    pa.forEach(p => {
      if (!existing.has(p.sn)) {
        devices.push(p);
      }
    });
  } catch (err) {
    console.warn("PurpleAir fetch failed:", err);
  }

  // Render dropdown, map, etc.
  populateSelect();
  updateMap();

  // Select first device if any, show info, draw chart
  if (devices.length > 0) {
    sel.value = devices[0].sn;
    showInfo(sel.value);
    updateChartForDevice(sel.value);
  } else {
    info.textContent = "No devices available.";
  }
}

/* ================== EVENT HANDLERS ================== */
refreshBtn.onclick = () => {
  showInfo(sel.value);
  updateChartForDevice(sel.value);
};

sel.onchange = () => {
  showInfo(sel.value);
  updateChartForDevice(sel.value);
};

/* GO */
init();
</script>

</body>
</html>
